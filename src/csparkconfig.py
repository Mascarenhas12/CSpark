import chess
import chess.pgn
from utils import extract_elo_from_pgn, estimated_move_value

DEFAULT_EMV = {
    "R14": 2,
    "R15": 1.5
    }
DEFAULT_MOVE_PROB = {'0': 0.19860551711478275, '1': 0.09886722014266597, '2': 0.06562112115196038, '3': 0.048998071656607585, '4': 0.039024241959395904, '5': 0.03237502216125479, '6': 0.02762557944829685, '7': 0.024063497413578393, '8': 0.021292989164352925, '9': 0.019076582564972553, '10': 0.017263158983661337, '11': 0.015751972665901993, '12': 0.014473276550874856, '13': 0.013377251309423023, '14': 0.012427362766831436, '15': 0.011596210292063796, '16': 0.010862840461386466, '17': 0.010210956167451062, '18': 0.009627691272877279, '19': 0.009102752867760876, '20': 0.008627808596465081, '21': 0.008196041077105268, '22': 0.007801818559428918, '23': 0.007440447918225596, '24': 0.00710798692831854, '25': 0.006801099860712027, '26': 0.006516945168483774, '27': 0.006253087239986111, '28': 0.0060074264100055275, '29': 0.005778142968690317, '30': 0.005563652007459958, '31': 0.005362566731306497, '32': 0.005173668441586579, '33': 0.004995881815967832, '34': 0.004828254426098728, '35': 0.00466993966900013, '36': 0.004520182466339295, '37': 0.0043783072217132395, '38': 0.00424370763065775, '39': 0.004115838019155037, '40': 0.003994205949676846, '41': 0.00387836588350714, '42': 0.003767913727391839, '43': 0.003662482123827233, '44': 0.0035617363693099435, '45': 0.003465370864989058, '46': 0.003373106020426508, '47': 0.0032846855443873974, '48': 0.0031998740673702913, '49': 0.0031184550494338693, '50': 0.003040228934161621, '51': 0.002965011515630613, '52': 0.002892632490251718, '53': 0.0028229341695164864, '54': 0.0027557703331716264, '55': 0.0026910052052676547, '56': 0.0026285125379918923, '57': 0.002568174790277363, '58': 0.0025098823899429874, '59': 0.002453533069619758, '60': 0.00239903126799565, '61': 0.002346287589004578, '62': 0.0022952183125211595, '63': 0.002245744950927848, '64': 0.00219779384661433, '65': 0.0021512958060678888, '66': 0.0021061857667317887, '67': 0.0020624024932585153, '68': 0.002019888300175772, '69': 0.0019785887983239632, '70': 0.001938452662721502, '71': 0.0018994314197746643, '72': 0.0018614792519770554, '73': 0.0018245528184442465, '74': 0.0017886110898056456, '75': 0.0017536151961312187, '76': 0.0017195282867080758, '77': 0.0016863154006034747, '78': 0.001653943347058484, '79': 0.001622380594852118, '80': 0.0015915971698607237, '81': 0.0015615645601130222, '82': 0.0015322556277086387, '83': 0.0015036445270281693, '84': 0.001475706628716652, '85': 0.001448418448970519, '86': 0.0014217575837013083, '87': 0.0013957026471882162, '88': 0.0013702332148664293, '89': 0.0013453297699295712, '90': 0.0013209736534528637, '91': 0.0012971470177691282, '92': 0.0012738327828527851, '93': 0.0012510145954878532, '94': 0.0012286767910148148, '95': 0.001206804357468298, '96': 0.0011853829019330495, '97': 0.0011643986189597449, '98': 0.001143838260894992, '99': 0.0011236891099915339, '100': 0.0011039389521752731, '101': 0.0010845760523554098, '102': 0.001065589131172825, '103': 0.0010469673430899057, '104': 0.0010287002557323752, '105': 0.0010107778304004585, '106': 0.0009931904036728765, '107': 0.0009759286700328425, '108': 0.0009589836654504238, '109': 0.0009423467518604125, '110': 0.0009260096024792304, '111': 0.0009099641879084266, '112': 0.0008942027629760441, '113': 0.0008787178542705454, '114': 0.0008635022483251424, '115': 0.0008485489804132808, '116': 0.000833851323918716, '117': 0.000819402780246093, '118': 0.0008051970692402367, '119': 0.000791228120084478, '120': 0.0007774900626503022, '121': 0.0007639772192724242, '122': 0.000750684096925081, '123': 0.0007376053797768884, '124': 0.0007247359221030669, '125': 0.000712070741535179, '126': 0.0006996050126297776, '127': 0.0006873340607385231, '128': 0.000675253356163412, '129': 0.0006633585085817642, '130': 0.0006516452617265538, '131': 0.0006401094883085436, '132': 0.0006287471851674958, '133': 0.0006175544686404937, '134': 0.0006065275701361136, '135': 0.000595662831903857, '136': 0.0005849567029888594, '137': 0.000574405735362485, '138': 0.0005640065802199434, '139': 0.0005537559844365809, '140': 0.0005436507871749683, '141': 0.0005336879166353502, '142': 0.00052386438694244, '143': 0.0005141772951619315, '144': 0.0005046238184404643, '145': 0.0004952012112631269, '146': 0.00048590680282289603, '147': 0.0004767379944967224, '148': 0.00046769225742324913, '149': 0.00045876713017742207, '150': 0.00044996021653750007, '151': 0.0004412691833402086, '152': 0.00043269175842000596, '153': 0.0004242257286286371, '154': 0.0004158689379313504, '155': 0.00040761928557633663, '156': 0.00039947472433412553, '157': 0.0003914332588038412, '158': 0.00038349294378337175, '159': 0.0003756518827006582, '160': 0.00036790822610344414, '161': 0.0003602601702049611, '162': 0.00035270595548314663, '163': 0.0003452438653311104, '164': 0.0003378722247566745, '165': 0.00033058939912891867, '166': 0.00032339379296975865, '167': 0.00031628384878868386, '168': 0.0003092580459588644, '169': 0.0003023148996329252, '170': 0.00029545295969676306, '171': 0.0002886708097598586, '172': 0.0002819670661806063, '173': 0.00027534037712525334, '174': 0.00026878942165910446, '175': 0.0002623129088687073, '176': 0.0002559095770137948, '177': 0.0002495781927078139, '178': 0.0002433175501259222, '179': 0.00023712647023938483, '180': 0.00023100380007535067, '181': 0.00022494841200103118, '182': 0.00021895920303134902, '183': 0.0002130350941591634, '184': 0.00020717502970721768, '185': 0.00020137797670099174, '186': 0.00019564292426167736, '187': 0.00018996888301852586, '188': 0.00018435488453985216, '189': 0.00017879998078200663, '190': 0.00017330324355565682, '191': 0.00016786376400874822, '192': 0.00016248065212553812, '193': 0.00015715303624112397, '194': 0.00015188006257090897, '195': 0.00014666089475447167, '196': 0.00014149471341332815, '197': 0.0001363807157220952, '198': 0.00013131811499258314, '199': 0.0001263061402703662, '200': 0.00012134403594339524, '201': 0.00011643106136223585, '202': 0.00011156649047153124, '203': 0.0001067496114523041, '204': 0.00010197972637472799, '205': 9.725615086101183e-05, '206': 9.25782137580562e-05, '207': 8.794525681955207e-05, '208': 8.335663439720589e-05, '209': 7.88117131407868e-05, '210': 7.430987170670345e-05, '211': 6.985050047482841e-05, '212': 6.543300127329964e-05, '213': 6.105678711103749e-05, '214': 5.672128191772661e-05, '215': 5.242592029102046e-05, '216': 4.817014725073557e-05, '217': 4.3953417999811085e-05, '218': 3.9775197691817416e-05, '219': 3.563496120480551e-05, '220': 3.1532192921295986e-05, '221': 2.7466386514214458e-05, '222': 2.343704473858659e-05, '223': 1.9443679228812534e-05, '224': 1.548581030134758e-05, '225': 1.1562966762621258e-05, '226': 7.674685722033493e-06, '227': 3.820512409871936e-06}


class CSparkConfig:
    def __init__(self, pgn_path, colour: str, emv_dict: dict = DEFAULT_EMV, move_prob_dict: dict = DEFAULT_MOVE_PROB):
        self.pgn_path = pgn_path
        self.colour = colour
        self.elo_dict = extract_elo_from_pgn(pgn_path, colour)
        self.emv = estimated_move_value(emv_dict, self.elo_dict.get('elo'))
        self.opponent_emv = estimated_move_value(emv_dict, self.elo_dict.get('opponent_elo'))
        self.move_prob_dict = move_prob_dict

    def get_pgn(self):
        return self.pgn_path

    def get_colour(self):
        return self.colour

    def get_elo(self):
        return self.elo_dict.get('elo')

    def get_opponent_elo(self):
        return self.elo_dict.get('opponent_elo')

    def get_emv(self):
        return self.emv

    def get_opponent_emv(self):
        return self.opponent_emv

    def get_move_prob_dict(self):
        return self.move_prob_dict

    def get_fen_list_from_pgn(self):
        fen_list = []
        with open(self.pgn_path, 'r') as pgn:
            game = chess.pgn.read_game(pgn)

        board = game.board()
        fen_list.append(board.fen())

        for move in game.mainline_moves():
            board.push(move)
            fen_list.append(board.fen())

        return fen_list
